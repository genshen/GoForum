<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" />
    <meta name="theme-color" content="#1ba10f">
    <title>首页</title>
    <!-- Material Design fonts -->
    <!-- <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">  -->
     <link href="//cdn.bootcss.com/material-design-icons/2.2.3/iconfont/material-icons.css">
     <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Material Design -->
    <link href="/static/dist/css/bootstrap-material-design.css" rel="stylesheet">
    <link href="/static/dist/css/ripples.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/static/dist/css/snackbar.css">
</head>
<body>
<main id="app" style="margin-bottom:72px"> <!--footer:60px-->
    <home-grid :home="home"></home-grid>
    <category-grid :category="category"></category-grid>
    <message-grid :message="message"></message-grid>
    <user-grid :user="me"></user-grid>
    <a href="javascript:void(0)" class="btn btn-primary btn-fab"
       style="position:fixed;right:15px;bottom:75px;padding-top: 14px;">
        <span class="glyphicon glyphicon-refresh" title="刷新"></span>
    </a>
</main>

<!--home template-->
<script type="text/x-template" id="home-template">
    <div class="container" v-show="home.active">
        <div v-show="home.loaded">
            <h1>Home</h1>
            <div class="row">
                <!-- Carousel Card -->
                <div id="home-owl" class="owl-carousel">
                    <div v-for="swipe in home.swipes">
                        <a v-bind:href=" swipe.Url" target="_blank">
                        <img v-bind:src=" swipe.Img" alt="Awesome Image">
                        </a>
                    </div>
                </div>  <!--owl-carousel-->
            </div>  <!--/row--->

            <div v-for="hot in home.hot_posts" class="list-group">
                <div class="list-group-item">
                    <div class="row-picture">
                        <img class="circle" src="http://lorempixel.com/56/56/people/1" alt="icon">
                    </div>
                    <div class="row-content">
                        <span> {{hot.Name}}</span> <!--class="list-group-item-heading"-->
                        <span class="glyphicon glyphicon-eye-open"></span><span>{{hot.ViewCount}}</span>
                        <span class="glyphicon glyphicon-dashboard"></span><span>{{hot.CommentCount}}</span>
                        <p class="list-group-item-text">
                            <a v-bind:href="'/post/'+hot.PostID">{{hot.Title}}</a>
                        </p>
                    </div>
                </div>
                <div class="list-group-separator"></div>
            </div>
            <a @click="loadMore('btn')" :disabled="!home.loading_enable">{{home.hot_loading_text}}</a>
        </div>
        <div v-show="!home.loaded">
            <span>正在加载...</span>
        </div> <!--/home.loaded-->
    </div>  <!--/home.active-->
</script>
<!--category template-->
<script type="text/x-template" id="category-template">
    <div class="container" v-show="category.active">
        <div v-show="category.loaded">
            <h1>category</h1>
            <h4>热门标签</h4>
            <div class="tag-container">
                <a v-for="tag in category.tags" class="category-tag" v-bind:style="{background:tag.Color}">
                    {{tag.Name}}
                </a>
            </div>
            <h4>话题</h4>
            <div class="topic-container">
                <div v-for="topic in category.topics" v-bind:style="{background:topic.Color}"
                     class="col-md-3 col-md-4 col-sm-6 category-topic">
                    <h4><a v-bind:href="'/topic/'+topic.Sulg">{{topic.Name}}</a></h4>
                    <span class="text-info">{{topic.Describe}}</span>
                </div>
            </div> <!--/topic-container-->
        </div>
        <div v-show="!category.loaded">
            <button v-bind:click="loadMore">正在加载...</button>
        </div> <!--/category.loaded-->
    </div> <!--/category.active-->
</script>
<!--message template-->
<script type="text/x-template" id="message-template">
    <div class="container" v-if="message.active">
        <h1>Nessage</h1>
        <div v-for="msg in messages">
            {{msg}}
        </div>
    </div>
</script>
<!--me template-->
<script type="text/x-template" id="user-template">
  <div class="container" v-if="user.active" style="color: rgb(102,102,102);padding: 0px;">
      <ul class="Me-menue-list list-unstyled">
          <li class="list-login">
              <a herf="#">
                  <span class="row-picture">
                      <img class="circle" src="http://lorempixel.com/56/56/people/1" alt="icon"/>
                  </span>
                  <span>尚未登陆</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-home glyphicon-left"></span>
                  <span>我的帖子</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-user glyphicon-left"></span>
                  <span>关注的人</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-heart-empty glyphicon-left"></span>
                  <span>我的粉丝</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-star-empty glyphicon-left"></span>
                  <span>我的收藏</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-cog glyphicon-left"></span>
                  <span>设置</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-info-sign glyphicon-left"></span>
                  <span>关于我们</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
          <li class="list-info">
              <a herf="#">
                  <span class="glyphicon glyphicon-phone-alt glyphicon-left"></span>
                  <span>意见反馈</span>
                  <span class="glyphicon glyphicon-chevron-right pull-right"></span>
              </a>
          </li>
      </ul>
  </div>
</script>

<footer>
    <div class="container-fluid">
        <ul class="row tab-bar text-center">
            <li class="active col-xs-3" v-on:click="greetHome"  data-toggle="tab">
                <a href="#home">
                    <span class="glyphicon glyphicon-home"></span><br>
                    <span class="footer-text">首页</span>
                </a>
            </li>
            <li class="col-xs-3" v-on:click="greetCategory"  data-toggle="tab">
                <a href="#category">
                    <span class="glyphicon glyphicon-search"></span><br>
                    <span class="footer-text">发现</span>
                </a>
            </li>
            <li class="col-xs-3" v-on:click="greetMessage" data-toggle="tab">
                <a href="#message">
                    <span class="glyphicon glyphicon-comment"></span><br>
                    <span class="footer-text">消息</span>
                </a>
            </li>
            <li class="col-xs-3" v-on:click="greetMe" data-toggle="tab">
                <a>
                    <span class="glyphicon glyphicon-user"></span><br>
                    <span class="footer-text">我</span>
                </a>
            </li>
        </ul>
    </div>

</footer>
<!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.js"></script>
<!-- Twitter Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<!-- Material Design for Bootstrap -->
<script src="/static/dist/js/material.min.js"></script>
<script src="/static/dist/js/ripples.min.js"></script>
<script src="/static/dist/js/vue.js"></script>
<script src="/static/dist/js/owl.carousel.min.js"></script>
<script src="/static/dist/js/snackbar.min.js"></script>
<script>
    var SHOW_HOME = 1,
            SHOW_CATEGORY = 2,
            SHOW_MESSAGE = 4,
            SHOW_ME = 8;

    Vue.component('home-grid', {
        template: '#home-template',
        props: {
            home: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {
            loadMore: function () {
                console.log(this.home.hot_start);
                requestHotPosts(this, this.home.hot_start);
            }
        }
    });

    Vue.component('category-grid', {
        template: '#category-template',
        props: {
            category: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

    Vue.component('message-grid', {
        template: '#message-template',
        props: {
            message: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

    Vue.component('user-grid', {
        template: '#user-template',
        props: {
            user: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

    var vue = new Vue({
        el: "html",
        data: {
            title: "首页",
            home: {
                loaded: false,
                active: true,
                swipes: [],
                hot_posts: [],
                hot_start: 0,
                hot_loading_text: "加载更多",
                hot_loading_enable: true
            },
            category: {loaded: false, active: false, tags: [], topics: []},
            message: {loaded: false, active: false},
            me: {loaded: false, active: false,id:0,isLogin:false,name:"点击登录",head:"default.png"},
            setting: {}
        },
        ready: function () {
            //init
        },
        methods: {
            //status = 1/2/4/8 only
            show: function (status) {
                this.home.active = (status & SHOW_HOME) == SHOW_HOME;
                this.category.active = (status & SHOW_CATEGORY) == SHOW_CATEGORY;
                this.message.active = (status & SHOW_MESSAGE) == SHOW_MESSAGE;
                this.me.active = (status & SHOW_ME) == SHOW_ME;
            },
            greetHome: function () {
                this.show(SHOW_HOME);
                if (!this.home.loaded) {
                    requestHomeData(this);
                }
            },
            greetCategory: function () {
                this.show(SHOW_CATEGORY);
                if (!this.category.loaded) {
                    requestCategoryData(this);
                }
            },
            greetMessage: function () {
                this.show(SHOW_MESSAGE);
                if (!this.message.loaded) {
                    console.log("no data");
                    this.message.loaded = true;
                }
            },
            greetMe: function () {
                this.show(SHOW_ME);
                if (!this.me.loaded) {
                    getUserStatus(this);
                }
            }
        }
    });

    //第一次加载失败(swipt 与 hot),可以通过点击首页重试
    function requestHomeData(self) {
        $.ajax({
            type: 'GET',
            url: "/home/swipe/",
            success: function (data) {
                if (data.length == 0) { //todo
                    //  未找到相关内容;
                }
                self.home.swipes = []; //防止重试加载时会数据重叠
                data.forEach(function (e) {
                    self.home.swipes.push(e);
                });
                self.home.hot_loading_text = "正在加载";
                self.home.hot_loading_enable = false;
                requestHotPosts(self, self.home.hot_start);
            }, error: function (err) {
                // 加载失败,重新加载
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
                //  console.log(err);
            }
        });
    }

    //请求热门帖子的数据
    //第一次由父组件调用,以后加载更多及失败的重试都由子组件负责
    function requestHotPosts(self, start) {
        $.ajax({
            type: 'GET',
            url: "/home/hot/" + start,
            success: function (data) { //todo use try catch: data may be not json format
                if (data.length == 0) { //todo
                    self.home.hot_loading_enable = false;
                    self.home.hot_loading_text = "没有更多内容了";
                    return;
                }
                data.forEach(function (e) {
                    self.home.hot_posts.push(e);
                });
                self.home.hot_start += data.length;
                self.home.loaded = true;
                self.home.hot_loading_text = "加载更多";
                self.home.hot_loading_enable = true;
                $("#home-owl").owlCarousel({
                    autoPlay: 4000,
                    stopOnHover: true,
                    pagination: true,
                    slideSpeed: 300,
                    paginationSpeed: 400,
                    singleItem: true
                }); //初始化轮播图
                // $("#home-owl").owlCarousel({autoplay:true,autoplayTimeout:5000,autoplayHoverPause:true,center: true,loop:true,autoWidth:true,items:1});   //2.0初始化轮播图
            }, error: function (err) {
                self.home.hot_loading_enable = true;
                self.home.hot_loading_text = "加载失败,请重试";
                var options = {content: "加载失败,请重试", timeout: 2000};
                $.snackbar(options);
                // console.log(err);
            }
        });
    }

    //请求发现页面的数据
    function requestCategoryData(self) {
        $.ajax({
            type: 'GET',
            url: "/home/category/",
            success: function (data) {
                //todo if length ==0 未找到相关内容;
                self.category.tags = []; //防止重试加载时会数据重叠
                self.category.topic = [];
                data.Tags.forEach(function (e) {
                    self.category.tags.push(e);
                });
                data.Topics.forEach(function (e) {
                    self.category.topics.push(e);
                });
                self.category.loaded = true;
            }, error: function (err) {
                // 加载失败,重新加载
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
                //  console.log(err);
            }
        });
    }

    //获取用户信息
    function getUserStatus(self) {
        $.ajax({
            type: 'GET',
            url: "/home/me/",
            success: function (data) {
                self.me.isLogin = data.IsLogin;
                if(data.IsLogin){
                    self.me.id = data.ID;
                    self.me.name = data.Name;
                    self.me.head = data.Head;
                }

                self.me.loaded = true;
            }, error: function (err) {
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
            }
        });
    }
</script>
</body>
</html>
