{{define "content"}}{{template "header" .}}
<link type="text/css" rel="stylesheet" href="/static/dist/css/snackbar.css">
{{template "header_foo" .}}
<main id="app" style="margin-bottom:72px"> <!--footer:60px-->
    <home-grid :home="home"></home-grid>
    <category-grid :category="category"></category-grid>
    <message-grid :message="message"></message-grid>
    <user-grid :user="me"></user-grid>
    <a href="javascript:void(0)" class="btn btn-primary btn-fab"
       style="position:fixed;right:20px;bottom:80px;padding-top: 14px;">
        <span class="glyphicon glyphicon-refresh" title="刷新"></span>
    </a>
</main>
<!--home template-->
<script type="text/x-template" id="home-template">
    <div class="container" v-show="home.active">
        <div v-show="home.loaded">
            <h1>Home</h1>
            <div class="row">
                <!-- Carousel Card -->
                <div id="home-owl" class="owl-carousel">
                    <div v-for="swipe in home.swipes">
                        <a v-bind:href="{{" swipe.Url"}}" target="_blank">
                        <img v-bind:src="{{" swipe.Img"}}" alt="Awesome Image">
                        </a>
                    </div>
                </div>  <!--owl-carousel-->
            </div>  <!--/row--->

            <div v-for="hot in home.hot_posts" class="list-group">
                <div class="list-group-item">
                    <div class="row-picture">
                        <img class="circle" v-bind:src="hot.Cover" alt="icon">
                    </div>
                    <div class="row-content">
                        <div>
                            <small>{{"{{hot.Name}}"}}</small><!--class="list-group-item-heading"-->
                            <small class="pull-right">
                                <span class="glyphicon glyphicon-dashboard"></span><span>&nbsp;&nbsp;{{"{{hot.CommentCount}}"}}&nbsp;&nbsp;</span>
                            </small>
                            <small class="pull-right">
                                <span class="glyphicon glyphicon-eye-open"></span><span>&nbsp;&nbsp;{{"{{hot.ViewCount}}"}}&nbsp;&nbsp;</span>
                            </small>
                        </div>
                        <div class="list-group-item-date">
                            <small>2016.7.11</small>
                        </div>
                        <div>
                            <p class="list-group-item-text">
                                <a v-bind:href="'/post/'+hot.PostID">{{"{{hot.Title}}"}}</a>
                            </p>
                        </div>
                    </div><!--class="row-content"-->
                </div><!--class="list-group-item"-->
            </div><!--calss="list-group"-->

            <a @click="loadMore('btn')" :disabled="!home.loading_enable">{{"{{home.hot_loading_text}}"}}</a>
        </div>
        <div v-show="!home.loaded">
            <span>正在加载...</span>
        </div> <!--/home.loaded-->
    </div>  <!--/home.active-->
</script>
<!--category template-->
<script type="text/x-template" id="category-template">
    <div class="container" v-show="category.active">
        <div v-show="category.loaded">
            <h1>category</h1>
            <h4>热门标签</h4>
            <div class="tag-container">
                <a v-for="tag in category.tags" class="category-tag" v-bind:style="{background:tag.Color}">
                    {{"{{tag.Name}}"}}
                </a>
            </div>
            <h4>话题</h4>
            <div class="topic-container">
                <div v-for="topic in category.topics" v-bind:style="{background:topic.Color}"
                     class="col-md-3 col-md-4 col-sm-6 category-topic">
                    <h4><a v-bind:href="'/topic/'+topic.Slug">{{"{{topic.Name}}"}}</a></h4>
                    <span class="text-info">{{"{{topic.Describe}}"}}</span>
                </div>
            </div>  <!--/topic-container-->
        </div>
        <div v-show="!category.loaded">
            <button v-bind:click="loadMore">正在加载...</button>
        </div> <!--/category.loaded-->
    </div> <!--/category.active-->
</script>
<!--message template-->
<script type="text/x-template" id="message-template">
    <div class="container" v-show="message.active">
        <h1>Nessage</h1>
        <div v-for="msg in messages">
            {{"{{msg}}"}}
        </div>
    </div>
</script>
<!--me template-->
<script type="text/x-template" id="user-template">
    <div class="container" v-show="user.active">
        <ul class="row me-menu-list list-unstyled">
            <li class="me-profile withripple" @click="toProfile">
                <div class="me-list-container me-split-line-ignore">
                    <a>
                        <img class="img-circle" v-bind:src="user.cover" alt="正在加载"/>
                        <span class="me-profile-username">{{"{{user.name}}"}}</span>
                        <span class="glyphicon glyphicon-chevron-right pull-right"></span>
                    </a>
                </div>
            </li>
            <li v-for="list in lists"
                v-bind:class="{ 'me-white-space':list.is_space,'list-info':!list.is_space,'withripple':!list.is_space }">
                <div v-if="!list.is_space" v-bind:class="{'me-split-line-ignore':list.islast}"
                     v-bind:onclick="'jumpDelay(\''+list.link+'\')'" class="me-list-container">
                    <a herf="#">
                        <span v-bind:class="list.icon" class="me-list-icon-left glyphicon glyphicon-left"></span>
                        <span class="me-list-name">{{"{{list.name}}"}}</span>
                        <!--bookmark border-->
                        <!--<span class="glyphicon glyphicon-chevron-right pull-right"></span>-->
                    </a>
                </div>
            </li>
        </ul>
    </div>
</script>
{{template "tabbar" .}}
{{template "script" .}}
<script src="/static/dist/js/vue.js"></script>
<script src="/static/dist/js/owl.carousel.min.js"></script>
<script src="/static/dist/js/snackbar.min.js"></script>
<script>
    $.material.init();
    var SHOW_HOME = 1,
            SHOW_CATEGORY = 2,
            SHOW_MESSAGE = 4,
            SHOW_ME = 8;

    Vue.component('home-grid', {
        template: '#home-template',
        props: {
            home: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {
            loadMore: function () {
                requestHotPosts(this, this.home.hot_start);
            }
        }
    });

    Vue.component('category-grid', {
        template: '#category-template',
        props: {
            category: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

    Vue.component('message-grid', {
        template: '#message-template',
        props: {
            message: JSON
        },
        ready: function () {
        },
        data: function () {
            return {}
        },
        methods: {}
    });

    Vue.component('user-grid', {
        template: '#user-template',
        props: {
            user: JSON
        },
        ready: function () {
        },
        data: function () {
            return {
                lists: [
                    {is_space: true},
                    {is_space: false, islast: false, name: "我的帖子", icon: "glyphicon-home", link: "#1"},
                    {is_space: false, islast: false, name: "关注的人", icon: "glyphicon-user", link: "/profile/following"},
                    {is_space: false, islast: false, name: "我的粉丝", icon: "glyphicon-heart-empty", link: "/profile/followed"},
                    {is_space: false, islast: true, name: "我的收藏", icon: "glyphicon-star-empty", link: "/profile/collection"},
                    {is_space: true},
                    {is_space: false, islast: true, name: "设置", icon: "glyphicon-cog", link: "#1"},
                    {is_space: true},
                    {is_space: false, islast: false, name: "关于我们", icon: "glyphicon-info-sign", link: "#1"},
                    {is_space: false, islast: true, name: "意见反馈", icon: "glyphicon-phone-alt", link: "#1"}]
            }
        }, methods: {
            toProfile: function () {
                if (this.user.isLogin) {
                    jumpDelay("/person/" + this.user.id);
                } else {
                    jumpDelay("/account/signin");
                }
            }
        }
    });

    var vue = new Vue({
        el: "html",
        data: {
            title: "首页",
            home: {
                loaded: false,
                active: true,
                swipes: [],
                hot_posts: [],
                hot_start: 0,
                hot_loading_text: "加载更多",
                hot_loading_enable: true
            },
            category: {loaded: false, active: false, tags: [], topics: []},
            message: {loaded: false, active: false},
            me: {loaded: false, active: false, id: 0, isLogin: false, name: "点击登录", cover: "default.png"},
            setting: {}
        },
        ready: function () {
            var hash = window.location.hash;
            var self = this;
            this.initByHash(hash, false);
            $(window).on("popstate", function (event) {
                console.log(window.location.hash);
                self.initByHash(window.location.hash, true);
            });
        },
        methods: {
            initByHash: function (hash, ispop) {
                if (hash == "" || hash == "#home") {
                    this.greetHome(ispop);
                } else if (hash == "#category") {
                    this.greetCategory(ispop);
                } else if (hash == "#message") {
                    this.greetMessage(ispop);
                } else if (hash == "#me") {
                    this.greetMe(ispop);
                }
            },
            //status = 1/2/4/8 only
            show: function (status) {
                this.home.active = (status & SHOW_HOME) == SHOW_HOME;
                this.category.active = (status & SHOW_CATEGORY) == SHOW_CATEGORY;
                this.message.active = (status & SHOW_MESSAGE) == SHOW_MESSAGE;
                this.me.active = (status & SHOW_ME) == SHOW_ME;
            },
            //初始化与点击tab时,history.pushState;
            greetHome: function (ispop) {
                if (ispop !== true) {
                    history.pushState(null, "home", "#home");
                }
                this.show(SHOW_HOME);
                if (!this.home.loaded) {
                    requestHomeData(this);
                }
            },
            greetCategory: function (ispop) {
                if (ispop !== true) {
                    history.pushState(null, "home", "#category");
                }
                this.show(SHOW_CATEGORY);
                if (!this.category.loaded) {
                    requestCategoryData(this);
                }
            },
            greetMessage: function (ispop) {
                if (ispop !== true) {
                    history.pushState(null, "home", "#message");
                }
                this.show(SHOW_MESSAGE);
                if (!this.message.loaded) {
                    console.log("no data");
                    this.message.loaded = true;
                }
            },
            greetMe: function (ispop) {
                if (ispop !== true) {
                    history.pushState(null, "home", "#me");
                }
                this.show(SHOW_ME);
                if (!this.me.loaded) {
                    getUserStatus(this);
                }
            }
        }
    });

    //第一次加载失败(swipt 与 hot),可以通过点击首页重试
    function requestHomeData(self) {
        $.ajax({
            type: 'GET',
            url: "/home/swipe/",
            success: function (data) {
                if (data.length == 0) { //todo
                    //  未找到相关内容;
                }
                self.home.swipes = []; //防止重试加载时会数据重叠
                data.forEach(function (e) {
                    self.home.swipes.push(e);
                });
                self.home.hot_loading_text = "正在加载";
                self.home.hot_loading_enable = false;
                requestHotPosts(self, self.home.hot_start);
            }, error: function (err) {
                // 加载失败,重新加载
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
                //  console.log(err);
            }
        });
    }

    //请求热门帖子的数据
    //第一次由父组件调用,以后加载更多及失败的重试都由子组件负责
    function requestHotPosts(self, start) {
        $.ajax({
            type: 'GET',
            url: "/home/hot/" + start,
            success: function (data) { //todo use try catch: data may be not json format
                if (data.length == 0) { //todo
                    self.home.hot_loading_enable = false;
                    self.home.hot_loading_text = "没有更多内容了";
                    return;
                }
                data.forEach(function (e) {
                    self.home.hot_posts.push(e);
                });
                self.home.hot_start += data.length;
                self.home.loaded = true;
                self.home.hot_loading_text = "加载更多";
                self.home.hot_loading_enable = true;
                $("#home-owl").owlCarousel({
                    autoPlay: 4000,
                    stopOnHover: true,
                    pagination: true,
                    slideSpeed: 300,
                    paginationSpeed: 400,
                    singleItem: true
                }); //初始化轮播图
                // $("#home-owl").owlCarousel({autoplay:true,autoplayTimeout:5000,autoplayHoverPause:true,center: true,loop:true,autoWidth:true,items:1});   //2.0初始化轮播图
            }, error: function (err) {
                self.home.hot_loading_enable = true;
                self.home.hot_loading_text = "加载失败,请重试";
                var options = {content: "加载失败,请重试", timeout: 2000};
                $.snackbar(options);
                // console.log(err);
            }
        });
    }

    //请求发现页面的数据
    function requestCategoryData(self) {
        $.ajax({
            type: 'GET',
            url: "/home/category/",
            success: function (data) {
                //todo if length ==0 未找到相关内容;
                self.category.tags = []; //防止重试加载时会数据重叠
                self.category.topic = [];
                data.Tags.forEach(function (e) {
                    self.category.tags.push(e);
                });
                data.Topics.forEach(function (e) {
                    self.category.topics.push(e);
                });
                self.category.loaded = true;
            }, error: function (err) {
                // 加载失败,重新加载
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
                //  console.log(err);
            }
        });
    }

    //获取用户信息
    function getUserStatus(self) {
        $.ajax({
            type: 'GET',
            url: "/home/me/",
            success: function (data) {
                self.me.isLogin = data.IsLogin;
                if (data.IsLogin) {
                    self.me.id = data.ID;
                    self.me.name = data.Name;
                    self.me.cover = data.Cover;
                }
                self.me.loaded = true;
                $.material.ripples('.withripple'); //set ripple
            }, error: function (err) {
                var options = {content: "加载失败,请<a href='#'>重试</a>", timeout: 2000};
                $.snackbar(options);
            }
        });
    }

    function jumpDelay(url) {
        window.setTimeout(function () {
            window.location.href = url;
        }, 300);
    }
</script>
{{template "footer" .}}
{{end}}
